<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>User Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container mt-4">
    <h2>User Management</h2>
    <div class="d-flex justify-content-end mb-3">
        <button class="btn btn-primary" onclick="showAddUserModal()">Add New User</button>
    </div>
    <table class="table table-hover table-striped table-bordered">
        <thead class="table-dark">
        <tr>
            <th>ID</th>
            <th>Username</th>
            <th>Email</th>
            <th>Role</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody id="userTable"></tbody>
    </table>
</div>

<!-- Add/Edit User Modal -->
<div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="userModalTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <div class="mb-3">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" id="username" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" id="email" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="role" class="form-label">Role</label>
                        <select id="role" class="form-select">
                            <option value="ADMIN">ADMIN</option>
                            <option value="USER">USER</option>
                            <option value="CLIENT">CLIENT</option>
                        </select>
                    </div>
                    <input type="hidden" id="userId">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveUser()">Save</button>
            </div>
        </div>
    </div>
</div>

<script>
    const userTable = document.getElementById('userTable');
    const userModal = new bootstrap.Modal(document.getElementById('userModal'));

    async function fetchUsers() {
        try {
            const response = await axios.get('/api/users');
            renderUserTable(response.data);
        } catch (error) {
            console.error('Error fetching users:', error);
        }
    }

    function renderUserTable(users) {
        userTable.innerHTML = '';
        users.forEach(user => {
            userTable.innerHTML += `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td>${user.email}</td>
                    <td>${user.role}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="showEditUserModal(${user.id}, '${user.username}', '${user.email}', '${user.role}')">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">Delete</button>
                    </td>
                </tr>
            `;
        });
    }

    function showAddUserModal() {
        document.getElementById('userModalTitle').innerText = 'Add New User';
        document.getElementById('userForm').reset();
        document.getElementById('userId').value = '';
        userModal.show();
    }

    function showEditUserModal(id, username, email, role) {
        document.getElementById('userModalTitle').innerText = 'Edit User';
        document.getElementById('username').value = username;
        document.getElementById('email').value = email;
        document.getElementById('role').value = role;
        document.getElementById('userId').value = id;
        userModal.show();
    }

    async function saveUser() {
        const id = document.getElementById('userId').value;
        const userData = {
            username: document.getElementById('username').value,
            email: document.getElementById('email').value,
            role: document.getElementById('role').value
        };

        try {
            if (id) {
                await axios.put(`/api/users/${id}`, userData);
            } else {
                await axios.post('/api/users', userData);
            }
            userModal.hide();
            fetchUsers();
        } catch (error) {
            console.error('Error saving user:', error);
        }
    }

    async function deleteUser(id) {
        if (confirm('Are you sure you want to delete this user?')) {
            try {
                await axios.delete(`/api/users/${id}`);
                fetchUsers();
            } catch (error) {
                console.error('Error deleting user:', error);
            }
        }
    }

    window.onload = fetchUsers;
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
